# CLAUDE.md - UI Directory

This directory contains a React Router v7 web application that provides a user interface for viewing MLflow experiments and runs generated by the Pokemon AI agent.

## Architecture

- **Framework**: React Router v7 with TypeScript
- **Styling**: TailwindCSS with @webtui/theme-catppuccin
- **Build Tool**: Vite
- **MLflow Integration**: Custom MLFlowClient wrapper around mlflow-js

## Key Components

### MLFlowClient (`app/MLFlowClient.ts`)
- Type-safe wrapper around the mlflow-js library
- Connects to MLflow tracking server at `http://localhost:8080`
- Provides methods for:
  - Getting experiments by name
  - Listing runs for an experiment
  - Retrieving run details and artifacts
  - Searching traces with filtering options

### Routes
- **Home (`routes/_index.tsx`)**: Lists runs from the 'open-llms-play-pokemon' experiment
- **Run Detail (`routes/run.$runId.tsx`)**: Shows detailed view of a specific run

### Components
- **ExperimentsNav (`components/ExperimentsNav.tsx`)**: Navigation component for browsing runs
- **BoxContainer (`components/BoxContainer.tsx`)**: Layout container component

## Development Commands

- **Start development server**: `pnpm dev` (IMPORTANT: Do not run this command automatically - let the user run it manually)
- **Build for production**: `pnpm build`
- **Run all code quality checks**: `./check.sh` (format, lint, typecheck. Make sure to run this command in the root, not in the ui directory)
- **Start production server**: `pnpm start`

## Dependencies

### Core Dependencies
- `react` & `react-dom`: React 19
- `react-router`: React Router v7 for routing
- `mlflow-js`: MLflow JavaScript client
- `ky`: HTTP client for API requests
- `@webtui/css` & `@webtui/theme-catppuccin`: UI styling
- `@modelcontextprotocol/sdk`: MCP TypeScript SDK for game state parsing

### Development Dependencies
- `typescript`: TypeScript support
- `vite`: Build tool and dev server
- `tailwindcss`: CSS framework
- `@react-router/dev`: React Router development tools

## MLflow Integration

The UI connects to the MLflow tracking server that logs Pokemon AI agent runs. It displays:
- Experiment runs with status and timing information
- Run artifacts (screenshots, game state files)
- Trace data for debugging AI decision-making
- Metrics and parameters from each run

## MCP Integration

The UI integrates with the Model Context Protocol (MCP) to handle game state parsing:

### MCP Client (`app/mcp/McpClient.ts`)
- Handles stdio transport to Python MCP server
- Automatically spawns MCP server process when needed
- Provides `getGameStateFromFile()` method for parsing `.state` files
- Manages connection lifecycle and error handling

### Game State Processing
- **Old Format**: Direct JSON file reading from filesystem
- **New Format**: MCP server parses binary `.state` files into JSON
- Captures now save both `.png` screenshots and `.state` game files
- MCP server uses PyBoy emulator to load and parse game state data

### Error Handling
- Graceful fallback if MCP server fails to start
- Proper cleanup of child processes
- Detailed error messages for debugging

## Data Integration

The UI displays comprehensive data logged by the DSPy Pokemon agent (`main_dspy.py`):

### UI Components for Data Visualization
- **MetricsDisplay**: Shows progress metrics and history table
- **ScreenshotGallery**: Grid view of screenshots with modal enlargement
- **GameDataViewer**: Interactive JSON data explorer with structured views
- **Enhanced ExperimentsNav**: Shows run status and key metrics in sidebar

## Development Standards

### Design
- The UI is a terminal UI (TUI) rendered to the web.
- Use font weights instead of font sizes to maintain the monospace console like text layout.
- Do NOT change font sizes for text. (Aka don't use `className="text-sm"` or similar.)

### CSS Units
- Use `ch` units for x-axis sizing (widths, horizontal padding/gaps)
- Use `lh` units for y-axis sizing (heights, vertical padding/gaps)
- Ensures consistent spacing relative to font metrics

### Code Quality
- Use `Number.parseInt()` instead of global `parseInt()`
- Provide meaningful keys for mapped elements (avoid array indexes)
- Use `htmlFor` and `id` attributes for form label accessibility
- Follow Biome linting rules for consistent code style

## Usage Notes

- Ensure MLflow server is running on `http://localhost:8080` before starting the UI
- The application expects the 'open-llms-play-pokemon' experiment to exist
- Screenshots and game state artifacts are displayed for debugging agent behavior
- **MCP Integration**: The UI uses Model Context Protocol (MCP) via stdio transport to parse `.state` files
  - MCP server is automatically spawned as a child process when needed
  - Game state parsing is handled by the Python MCP server instead of direct file reads
  - Supports the new `.state` file format from interactive captures
- Use `pnpm` for package management and development commands